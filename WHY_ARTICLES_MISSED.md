# 왜 기사들이 놓치게 되었는가?

## 로그 분석

### 로그에서 확인된 사실

1. **프롬프트 변경 감지 메시지 없음**
   - `[INFO] ⚠️ 프롬프트가 변경되었습니다!` 메시지가 없음
   - `[INFO] 💡 이미 제외된 기사들도 새로운 기준으로 재검토합니다.` 메시지가 없음

2. **재검토 모드 메시지 없음**
   - `[INFO] 🔄 재검토 모드: N건의 기사를 새로운 기준으로 재검토합니다.` 메시지가 없음
   - `🔄 재검토 대상: ...` 메시지가 없음

3. **모든 기사가 "중복 기사 링크 발견"으로 제외됨**
   - `⏭️ 중복 기사 링크 발견: ...` 메시지만 출력됨

---

## 원인 분석

### 시나리오 1: 프롬프트 변경이 이미 처리됨

**가능성: 높음**

1. 프롬프트가 이전에 변경됨
2. 프롬프트 해시가 `state.aitest.json`에 저장됨
3. 이번 실행에서는 프롬프트가 변경되지 않아서 `prompt_changed = False`
4. 따라서 재검토 모드가 활성화되지 않음
5. 이미 `seen_links`에 있는 기사들은 그냥 제외됨

**증거:**
- 로그에 프롬프트 변경 감지 메시지가 없음
- 재검토 모드 메시지가 없음

---

### 시나리오 2: 프롬프트 변경 감지가 작동하지 않음

**가능성: 낮음**

1. 프롬프트 파일이 변경되었지만 해시 계산 실패
2. 또는 state 파일에 `prompt_hash`가 없어서 첫 실행으로 인식

**증거:**
- 로그에 `[WARN] 프롬프트 해시 계산 실패` 메시지가 없음
- 프롬프트 해시 관련 에러가 없음

---

### 시나리오 3: 기사들이 프롬프트 변경 전에 처리됨

**가능성: 높음**

1. 이 기사들은 프롬프트 변경 **전**에 처리됨
2. 그때는 이전 기준으로 판단됨 (취약점 기준: 4개 제품만)
3. 이전 기준에서는 제외됨 (아파치, LinkedIn, 제미나이는 허용 목록에 없음)
4. `seen_links`에 저장됨
5. 프롬프트가 변경됨 (취약점 기준 확대)
6. 하지만 이미 `seen_links`에 있어서 중복으로 제외됨
7. 프롬프트 변경 감지는 **변경 시점**에만 작동하므로, 이미 처리된 기사는 재검토되지 않음

**증거:**
- 로그에 프롬프트 변경 감지 메시지가 없음
- 모든 기사가 "중복 기사 링크 발견"으로 제외됨

---

## 핵심 문제

**코드 버그: 중복 체크에서 재검토 로직이 누락됨**

코드를 확인한 결과, `seen_links`에 있는 기사를 체크할 때 `prompt_changed`를 확인하지 않고 바로 제외하고 있었습니다:

```python
# 기존 코드 (버그)
if normalized_link and normalized_link in seen_links:
    print(f"⏭️ 중복 기사 링크 발견: {title[:50]}...")
    continue  # 바로 제외, 재검토 로직 없음
```

**올바른 로직:**
- 프롬프트가 변경되면 → `seen_links`에 있는 기사도 재검토 대상에 추가해야 함
- 하지만 코드에서 이 부분이 누락되어 있었음

---

## 해결 방법

### 방법 1: State 파일에서 링크 제거 (수동)

`state.aitest.json`에서 해당 기사 링크를 `seen_links`에서 제거:
- 아파치 bRPC 기사 링크
- LinkedIn 기사 링크
- 제미나이 기사 링크
- Net-NTLMv1 기사 링크

다음 실행 시 새 기사로 인식되어 재검토됨

### 방법 2: State 파일 초기화 (완전 재검토)

`state.aitest.json` 삭제 후 처음부터 재검토

### 방법 3: 프롬프트 변경 감지 로직 개선 (코드 수정)

프롬프트 변경 시점뿐만 아니라, 프롬프트가 변경된 이후에도 최근 N일간의 기사를 재검토하도록 개선

---

## 결론

**왜 놓치게 되었는가?**

1. 이 기사들은 프롬프트 변경 **전**에 처리됨
2. 그때는 이전 기준으로 제외됨 (취약점 기준: 4개 제품만)
3. `seen_links`에 저장됨
4. 프롬프트가 변경됨 (취약점 기준 확대)
5. **코드 버그**: 중복 체크에서 `prompt_changed`를 확인하지 않고 바로 제외
6. 따라서 재검토 모드가 활성화되지 않음
7. 이미 `seen_links`에 있어서 중복으로 제외됨

**해결책:**
- ✅ **코드 수정 완료**: 중복 체크에서 `prompt_changed` 확인 로직 추가
- 다음 실행 시 프롬프트가 변경되면 자동으로 재검토됨
- 또는 State 파일에서 해당 기사 링크를 제거하여 즉시 재검토 가능
